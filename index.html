<!DOCTYPE html>
<html lang="uk">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–±–ª–∏—Ü—è —Ä–µ—Ñ–∞—É–Ω–¥—É</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --bg: #0f1220;
            --card: #171a2b;
            --card2: #1f2235;
            --line: #2a2d3d;
            --accent: #7c5cff;
            --accent2: #674bdb;
            --text: #e8ecf1;
            --input-bg: #2a2d3d;
            --border-radius: 10px;
            --base-font-size: 16px;
        }

        .light-theme {
            --bg: #f5f7fa;
            --card: #e6eaf0;
            --card2: #dbe2e9;
            --line: #c4ccd4;
            --accent: #5c6ac4;
            --accent2: #485493;
            --text: #2c3e50;
            --input-bg: #f0f2f5;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Ubuntu', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; font-size: var(--base-font-size); touch-action: manipulation; }
        h1 { text-align: center; color: var(--accent); margin-bottom: 16px; font-weight: 700; }
        .converter { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 20px; background: var(--card2); padding: 12px; border-radius: var(--border-radius); flex-wrap: wrap; }
        .converter label { display: flex; gap: 6px; align-items: center; }
        .converter input { width: 140px; padding: 8px; border: none; border-radius: 8px; background: var(--input-bg); color: var(--text); text-align: right; }
        .converter .rate { font-weight: 600; opacity: .9; }
        .actions { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .actions-left { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .actions-right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .stats { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .stat { background: var(--card2); padding: 8px 12px; border-radius: var(--border-radius); font-size: 0.95rem; font-weight: 500; }
        select { 
            padding: 8px 10px; 
            border-radius: 8px; 
            background: var(--input-bg); 
            color: var(--text); 
            border: none;
            vertical-align: middle;
        }
        select.month {
            width: 120px;
            font-size: 1rem;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; background-color: var(--card); border-radius: var(--border-radius); overflow: hidden; table-layout: fixed; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--line); vertical-align: middle; position: relative; }
        th { background-color: var(--card2); position: sticky; top: 0; z-index: 1; user-select: none; }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"] { width: 100%; padding: 6px 8px; border: none; border-radius: 6px; background-color: var(--input-bg); color: var(--text); vertical-align: middle; font-size: 16px; }
        input[type="checkbox"] { transform: scale(1.2); }
        button { padding: 8px 12px; background-color: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease; }
        button:hover { background-color: var(--accent2); }
        .icon-btn { padding: 6px 10px; border-radius: 8px; }
        img.preview { max-width: 100px; max-height: 100px; border-radius: 6px; display: block; margin-top: 6px; object-fit: cover; cursor: pointer; }
        .image-col { min-width: 200px; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-backdrop.open { display: flex; }
        .modal { background: var(--card); padding: 20px; border-radius: 12px; max-width: 90vw; max-height: 90vh; overflow: auto; position: relative; z-index: 10000; }
        .modal img { max-width: 85vw; max-height: 80vh; display: block; }
        .modal .close { display: block; margin-left: auto; margin-bottom: 8px; }
        
        #auth-container { 
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            flex-direction: column; 
            background: var(--bg);
        }

        #auth-form {
            background: linear-gradient(145deg, var(--card), var(--card2));
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--line);
        }
        
        #auth-container h1 { 
            margin-top: 0; 
            font-size: 2rem;
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent), 0 0 10px rgba(124, 92, 255, 0.5);
        }

        #auth-container input {
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 15px;
            font-size: 16px;
        }

        #auth-container input:focus { 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 5px var(--accent);
        }

        .auth-buttons { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            margin-top: 15px;
        }

        .auth-buttons button { 
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        #loginBtn { background-color: var(--accent); }
        #signupBtn { 
            background-color: var(--card);
            border: 1px solid var(--line);
            color: var(--text);
            transition: background-color 0.2s ease;
        }
        #signupBtn:hover { background-color: var(--line); }

        #authMessage { 
            color: #f44336; 
            font-weight: 500; 
            margin-bottom: 15px; 
            text-align: left;
        }
        
        #app-container { display: none; }
        
        .right-aligned-container { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
            position: relative; 
        }
        
        #settingsPanel {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
            background: var(--card2); 
            padding: 8px 12px; 
            border-radius: var(--border-radius);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            visibility: hidden; 
            opacity: 0; 
            transition: visibility 0s, opacity 0.2s linear; 
        }
        #settingsPanel.open {
            visibility: visible;
            opacity: 1;
        }

        th.month-col { width: 120px; }
        
        .image-controls { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            margin-top: 6px; 
        }
        
        .delete-img-btn { 
            background: var(--accent);
            color: white; 
            padding: 6px 12px; 
            border: none; 
            border-radius: 8px;
            font-size: 1rem; 
            cursor: pointer; 
        }
        .delete-img-btn:hover { background-color: var(--accent2); }

        .resend-btn {
            background: none;
            color: var(--accent);
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            font-size: inherit;
        }
        
        .hidden {
            display: none;
        }
        
        .custom-file-upload {
            background-color: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
            display: inline-block;
            font-size: 1rem;
        }

        .custom-file-upload:hover {
            background-color: var(--accent2);
        }
        
        body.auth-locked {
            overflow: hidden;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: var(--text);
            opacity: 0.7;
        }

        .order-price-cell {
            position: relative;
        }
        .calculate-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            padding: 4px 8px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: none; /* Initially hidden */
        }
        
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            cursor: col-resize;
            z-index: 2;
        }
        .resize-handle:hover,
        .resize-handle:active {
            background-color: var(--line);
        }

        th { border-right: 1px solid var(--line); }

        @media (max-width: 768px) {
            .actions { flex-direction: column; align-items: stretch; }
            .actions-right, .actions-left { flex-direction: column; align-items: stretch; }
            .actions-right .right-aligned-container { flex-direction: row; justify-content: space-between; }
            .stats { flex-direction: column; align-items: stretch; gap: 8px; }
            .stat { text-align: center; }
            .converter { flex-direction: column; align-items: stretch; gap: 8px; }
            .converter input { width: 100%; text-align: center; }
            .converter label { justify-content: space-between; }
            
            .table-container { overflow-x: auto; width: 100%; }
            table { min-width: 1000px; }
        }

    </style>
</head>
<body>
    <div id="auth-container">
        <div id="auth-form">
            <h1>–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h1>
            <p id="authMessage"></p>
            <input type="email" id="emailInput" placeholder="Email" autocomplete="username">
            <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
            <div class="auth-buttons">
                <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
                <button id="signupBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
            </div>
            <button id="forgotPasswordBtn" class="resend-btn" style="margin-top: 15px;">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
            <button id="openGuideAuthBtn" style="margin-top: 15px; font-weight: normal; background-color: var(--card2); color: var(--text); border: 1px solid var(--line);">–ü–æ—Å—ñ–±–Ω–∏–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
        </div>
        <div class="footer">
            <a href="https://t.me/klodusref" target="_blank" style="color: var(--text); text-decoration: none;">made by telegram @klodusref</a>
        </div>
    </div>

    <div id="app-container">
        <div class="converter">
            <label>UAH: <input type="number" id="uahInput" step="0.01" placeholder="0.00"></label>
            <label>USD: <input type="number" id="usdInput" step="0.01" placeholder="0.00"></label>
            <span class="rate" id="rateInfo"></span>
        </div>

        <h1>–¢–∞–±–ª–∏—Ü—è —Ä–µ—Ñ–∞—É–Ω–¥—É</h1>
        <div class="actions">
            <div class="actions-left">
                <button id="addRowBtn" type="button">–î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button>
                <button id="clearDataBtn" type="button">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                <label>–ú—ñ—Å—è—Ü—å: <select id="monthFilter"><option value="all">–í—Å—ñ</option></select></label>
            </div>
            <div class="actions-right">
                <div class="stats">
                    <div class="stat">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫: <span id="totalProfit">0.00</span></div>
                    <div class="stat">–ó–∞–≥–∞–ª—å–Ω—ñ —Ç—Ä–∞—Ç–∏: <span id="totalCosts">0.00</span></div>
                    <div class="stat">–ó–∞–≥–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É: <span id="totalSales">0.00</span></div>
                </div>
                <div class="right-aligned-container">
                    <button id="openGuideAppBtn" class="icon-btn">üìñ</button>
                    <button id="settingsBtn">‚öôÔ∏è</button>
                    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
                    <div id="settingsPanel">
                        <label>–¢–µ–º–∞:
                            <select id="themeSelector">
                                <option value="dark">–¢–µ–º–Ω–∞</option>
                                <option value="light">–°–≤—ñ—Ç–ª–∞</option>
                            </select>
                        </label>
                        <label>–ú—ñ—Å—è—Ü—ñ:
                            <select id="monthFormatSelector">
                                <option value="words">–°–ª–æ–≤–∞–º–∏</option>
                                <option value="numbers">–¶–∏—Ñ—Ä–∞–º–∏</option>
                            </select>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="refundTable">
                <thead>
                    <tr>
                        <th class="month-col">–ú—ñ—Å—è—Ü—å<div class="resize-handle"></div></th>
                        <th>–ù–∞–∑–≤–∞ –ø—Ä–æ—Ñ—ñ–ª—é<div class="resize-handle"></div></th>
                        <th>–ü–æ—à—Ç–∞<div class="resize-handle"></div></th>
                        <th>–ü–∞—Ä–æ–ª—å<div class="resize-handle"></div></th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω<div class="resize-handle"></div></th>
                        <th>–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É<div class="resize-handle"></div></th>
                        <th>–¶—ñ–Ω–∞ —Ç–æ–≤–∞—Ä—É<div class="resize-handle"></div></th>
                        <th>–¶—ñ–Ω–∞ –ø—Ä–æ–≥—Ä—ñ–≤—É<div class="resize-handle"></div></th>
                        <th>–¶—ñ–Ω–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è<div class="resize-handle"></div></th>
                        <th>–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É<div class="resize-handle"></div></th>
                        <th>–†–µ—Ñ–Ω—É—Ç–∏–π —Ç–æ–≤–∞—Ä<div class="resize-handle"></div></th>
                        <th>–†–µ—Ñ–Ω—É—Ç–∏–π –ø—Ä–æ–≥—Ä—ñ–≤<div class="resize-handle"></div></th>
                        <th>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è<div class="resize-handle"></div></th>
                        <th>–ü—Ä–∏–±—É—Ç–æ–∫<div class="resize-handle"></div></th>
                        <th>–î—ñ—è<div class="resize-handle"></div></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="footer">
            <a href="https://t.me/klodusref" target="_blank" style="color: var(--text); text-decoration: none;">made by telegram @klodusref</a>
        </div>
    </div>

    <div id="imgModal" class="modal-backdrop">
        <div class="modal">
            <button class="close">X</button>
            <img src="">
        </div>
    </div>
    
    <div id="guideModal" class="modal-backdrop">
        <div class="modal">
            <button class="close">X</button>
<div>
    <h1>Klodus-ref: –¢–∞–±–ª–∏—Ü—è —Ä–µ—Ñ–∞—É–Ω–¥—É —Ç–∞ —ó—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</h1>
    <p>Klodus-ref ‚Äì —Ü–µ –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫, —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—à–∏—Ö —Ä–µ—Ñ–∞–Ω–¥—ñ–≤ —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π. –í—ñ–Ω –¥–æ–∑–≤–æ–ª—è—î –≤–∞–º –≤–µ—Å—Ç–∏ –æ–±–ª—ñ–∫ –¥–∞–Ω–∏—Ö, –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º —Ç–æ–≤–∞—Ä—ñ–≤, —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∏–±—É—Ç–æ–∫, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ –≤ —Ö–º–∞—Ä—ñ.</p>
    <h3>–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:</h3>
    <ul>
        <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å <strong>"–î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫"</strong>, —â–æ–± –≤–Ω–µ—Å—Ç–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å. –ü—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞, –º—ñ—Å—è—Ü—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π.</li>
        <li>–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤ –∫–ª—ñ—Ç–∏–Ω–∫–∞—Ö: –Ω–∞–∑–≤—É –ø—Ä–æ—Ñ—ñ–ª—é, –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ, –Ω–∞–∑–≤—É —Ç–æ–≤–∞—Ä—É, –π–æ–≥–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ç–∞ —ñ–Ω—à—ñ –≤–∏—Ç—Ä–∞—Ç–∏.</li>
        <li><strong>–ö–Ω–æ–ø–∫–∞ "–í–∏—Ä–∞—Ö—É–≤–∞—Ç–∏"</strong> –∑'—è–≤–∏—Ç—å—Å—è –ø–æ—Ä—É—á –∑ –ø–æ–ª–µ–º "–¶—ñ–Ω–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" —è–∫ —Ç—ñ–ª—å–∫–∏ –≤–∏ –∑–∞–ø–æ–≤–Ω–∏—Ç–µ –ø–æ–ª—è "–¶—ñ–Ω–∞ —Ç–æ–≤–∞—Ä—É" —Ç–∞/–∞–±–æ "–¶—ñ–Ω–∞ –ø—Ä–æ–≥—Ä—ñ–≤—É". –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —ó—ó, —â–æ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—É–º—É.</li>
        <li><strong>–î–æ–¥–∞—Ç–∫–æ–≤–æ:</strong> –í–∏ –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ —Ü—ñ–Ω—É –≤ –¥–æ–ª–∞—Ä–∞—Ö, –ø–æ—Å—Ç–∞–≤–∏–≤—à–∏ –≤ –∫—ñ–Ω—Ü—ñ –∑–Ω–∞–∫ `$` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '100$'). –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç—É—î —Å—É–º—É –≤ –≥—Ä–∏–≤–Ω—ñ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º –∫—É—Ä—Å–æ–º, —â–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</li>
        <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î –ø—Ä–∏–±—É—Ç–æ–∫, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ —Ü—ñ–Ω—É –ø—Ä–æ–¥–∞–∂—É —Ç–∞ –≤—Å—ñ –≤–∏—Ç—Ä–∞—Ç–∏.</li>
        <li>–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ–∫—ñ–≤ –∞–±–æ —Ç–æ–≤–∞—Ä—ñ–≤, —â–æ–± –º–∞—Ç–∏ –ø–æ–≤–Ω—É –∫–∞—Ä—Ç–∏–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—ó.</li>
    </ul>
    <p>3. <strong>–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</strong>:</p>
    <ul>
        <li>–£ –≤–µ—Ä—Ö–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ –µ–∫—Ä–∞–Ω–∞ –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ –∑–∞–≥–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: <strong>–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</strong>, <strong>–ó–∞–≥–∞–ª—å–Ω—ñ —Ç—Ä–∞—Ç–∏</strong> —Ç–∞ <strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É</strong>.</li>
        <li>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç, —â–æ–± –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—É–º–∏ –∑ –≥—Ä–∏–≤–µ–Ω—å –≤ –¥–æ–ª–∞—Ä–∏ —ñ –Ω–∞–≤–ø–∞–∫–∏.</li>
        <li>–¢–∞–∫–æ–∂ –≤–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∑–∞ –º—ñ—Å—è—Ü—è–º–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∏–ø–∞–¥–∞—é—á–æ–≥–æ –º–µ–Ω—é –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ—é.</li>
    </ul>
    <p>5. <strong>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</strong>:</p>
    <ul>
        <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —ñ–∫–æ–Ω–∫—É <strong>‚öôÔ∏è</strong> –¥–ª—è –∑–º—ñ–Ω–∏ —Ç–µ–º–∏ –¥–æ–¥–∞—Ç–∫–∞ –Ω–∞ —Å–≤—ñ—Ç–ª—É –∞–±–æ —Ç–µ–º–Ω—É, –∞ —Ç–∞–∫–æ–∂ —Ñ–æ—Ä–º–∞—Ç—É –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º—ñ—Å—è—Ü—ñ–≤.</li>
        <li>–í–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—ñ, –ø–æ—Ç—è–≥–Ω—É–≤—à–∏ –∑–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É –ª—ñ–Ω—ñ—é-—Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫, —â–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø—Ä–∞–≤–æ—Ä—É—á –≤—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–∂–Ω–æ—ó –∫–æ–ª–æ–Ω–∫–∏.</li>
    </ul>
    <p>Klodus-ref ‚Äî —Ü–µ –≤–∞—à –Ω–∞–¥—ñ–π–Ω–∏–π –ø–æ–º—ñ—á–Ω–∏–∫ —É –≤–µ–¥–µ–Ω–Ω—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ–±–ª—ñ–∫—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ –≤ –ø–æ—Ä—è–¥–∫—É —Ç–∞ –∑–∞–≤–∂–¥–∏ –º–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—ñ–¥ —Ä—É–∫–æ—é.</p>
    <p><strong>–ó–∞ –≤—Å—ñ–º–∞ –ø–∏—Ç–∞–Ω–Ω—è–º–∏ —Ç–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è–º–∏ –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å –≤ Telegram @klodusref</strong></p>
</div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // === –í–°–¢–ê–í–¢–ï –í–ê–®–£ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Æ FIREBASE –¢–£–¢ ===
        // –í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —ó—ó –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –≤–∞—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É Firebase -> Project settings -> General
        const firebaseConfig = {
            apiKey: "AIzaSyDYNup2IO9NDNi46jCHDI9Tlc28bqTw0P4",
            authDomain: "klodus-ref.firebaseapp.com",
            projectId: "klodus-ref",
            storageBucket: "klodus-ref.firebasestorage.app",
            messagingSenderId: "278121904226",
            appId: "1:278121904226:web:9815ac83f87de75608f93b",
            measurementId: "G-Z94H3RSL42",
            databaseURL: "https://klodus-ref-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let dbRef;
        let userSettingsRef;
        let columnWidthsRef;

        const uahInput = document.getElementById('uahInput');
        const usdInput = document.getElementById('usdInput');
        const rateInfo = document.getElementById('rateInfo');
        const addRowBtn = document.getElementById('addRowBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const tableBody = document.querySelector('#refundTable tbody');
        const monthFilter = document.getElementById('monthFilter');
        const totalProfitSpan = document.getElementById('totalProfit');
        const totalCostsSpan = document.getElementById('totalCosts');
        const totalSalesSpan = document.getElementById('totalSales');
        
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authMessage = document.getElementById('authMessage');
        const themeSelector = document.getElementById('themeSelector');
        const monthFormatSelector = document.getElementById('monthFormatSelector');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const openGuideAuthBtn = document.getElementById('openGuideAuthBtn');
        const openGuideAppBtn = document.getElementById('openGuideAppBtn');
        const guideModal = document.getElementById('guideModal');

        const IMGBB_API_KEY = "02d85ed13ea117549726ffbf155150d7";

        // Mappings for month formats
        const monthNames = ["–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å", "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"];

        // Firebase error translations
        const firebaseErrorMessages = {
            'auth/invalid-email': '–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email.',
            'auth/user-disabled': '–¶–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π.',
            'auth/user-not-found': '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.',
            'auth/wrong-password': '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å.',
            'auth/email-already-in-use': '–¶–µ–π email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ.',
            'auth/weak-password': '–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤.',
            'auth/operation-not-allowed': '–û–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∞.',
            'auth/invalid-credential': '–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å.'
        };
        
        // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ
        let exchangeRate = 41.3464; 
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—É—Ä—Å—É –∑ –ù–ë–£
        async function fetchExchangeRate() {
            const url = 'https://bank.gov.ua/NBUStatService/v1/statdirectory/dollar_info';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const rateNode = xmlDoc.getElementsByTagName('rate')[0];

                if (rateNode) {
                    const newRate = parseFloat(rateNode.textContent);
                    if (!isNaN(newRate)) {
                        exchangeRate = newRate;
                        rateInfo.textContent = `–ö—É—Ä—Å: 1 USD = ${exchangeRate.toFixed(4)} UAH`;
                    } else {
                        throw new Error('Invalid rate value');
                    }
                } else {
                    throw new Error('Rate tag not found in XML');
                }
            } catch (error) {
                console.error("Error fetching exchange rate:", error);
                rateInfo.textContent = `–ö—É—Ä—Å: 1 USD = ${exchangeRate.toFixed(4)} UAH (–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–æ)`;
            }
        }

        // Guide Modal Logic
        function openGuideModal() {
            guideModal.classList.add('open');
        }

        function closeGuideModal() {
            guideModal.classList.remove('open');
        }

        openGuideAuthBtn.addEventListener('click', openGuideModal);
        openGuideAppBtn.addEventListener('click', openGuideModal);
        guideModal.querySelector('.close').addEventListener('click', closeGuideModal);
        guideModal.addEventListener('click', e => {
            if (e.target.id === 'guideModal') { e.currentTarget.classList.remove('open'); }
        });

        // Settings Logic
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('open');
        });
        
        // Function to save user settings to Firebase
        function saveUserSettings() {
            const user = auth.currentUser;
            if (user) {
                const settings = {
                    theme: themeSelector.value,
                    monthFormat: monthFormatSelector.value
                };
                set(userSettingsRef, settings);
            }
        }
        
        // Function to save column widths to Firebase
        function saveColumnWidths() {
            const tableHeaders = document.querySelectorAll('#refundTable thead th');
            const widths = {};
            tableHeaders.forEach(th => {
                widths[th.textContent.trim()] = th.style.width;
            });
            const user = auth.currentUser;
            if (user) {
                set(columnWidthsRef, widths);
            }
        }

        // Function to load column widths from Firebase
        function loadColumnWidths(columnWidths) {
            if (columnWidths) {
                const tableHeaders = document.querySelectorAll('#refundTable thead th');
                tableHeaders.forEach(th => {
                    const headerText = th.textContent.trim();
                    if (columnWidths[headerText]) {
                        th.style.width = columnWidths[headerText];
                    }
                });
            }
        }

        function applyTheme(theme) {
            document.body.classList.toggle('light-theme', theme === 'light');
        }

        function getMonthString(monthNumber, format) {
            if (!monthNumber) return '';
            const index = parseInt(monthNumber, 10) - 1;
            const currentYear = new Date().getFullYear(); 
            
            if (format === 'numbers') {
                return `${String(index + 1).padStart(2, '0')}.${currentYear}`;
            } else {
                return monthNames[index];
            }
        }

        function updateMonthOptions(data) {
            const format = monthFormatSelector.value || 'words';
            
            // Update table select options
            document.querySelectorAll('select.month').forEach(select => {
                const savedMonthNumber = select.dataset.month;
                select.innerHTML = `
                    <option value="">-- –í–∏–±—Ä–∞—Ç–∏ –º—ñ—Å—è—Ü—å --</option>
                    ${monthNames.map((m, i) => `<option value="${i + 1}" ${savedMonthNumber == i + 1 ? 'selected' : ''}>${format === 'words' ? m : `${String(i + 1).padStart(2, '0')}.${new Date().getFullYear()}`}</option>`).join('')}
                `;
            });
            updateMonthFilter(data);
        }

        themeSelector.addEventListener('change', (e) => {
            applyTheme(e.target.value);
            saveUserSettings();
        });

        monthFormatSelector.addEventListener('change', (e) => {
            saveUserSettings();
            const currentData = Array.from(tableBody.querySelectorAll('tr')).map(tr => {
                return { month: tr.querySelector('.month').value };
            });
            updateMonthOptions(currentData);
            applyFilter();
        });

        // Auth Logic
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    window.location.reload();
                })
                .catch(error => {
                    const translatedMessage = firebaseErrorMessages[error.code] || error.message;
                    authMessage.innerHTML = translatedMessage;
                });
        });

        signupBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    sendEmailVerification(user)
                        .then(() => {
                            let seconds = 60;
                            authMessage.innerHTML = `–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–≤–æ—é –ø–æ—à—Ç—É –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç —â–µ —Ä–∞–∑ –º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ ${seconds} —Å.`;
                            const timer = setInterval(() => {
                                seconds--;
                                if (seconds > 0) {
                                    authMessage.innerHTML = `–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–≤–æ—é –ø–æ—à—Ç—É –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç —â–µ —Ä–∞–∑ –º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ ${seconds} —Å.`;
                                } else {
                                    clearInterval(timer);
                                    authMessage.innerHTML = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–≤–æ—é –ø–æ—à—Ç—É –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è. <button id='resendEmailBtn' class='resend-btn'>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —â–µ —Ä–∞–∑</button>";
                                    document.getElementById('resendEmailBtn').addEventListener('click', resendVerificationEmail);
                                }
                            }, 1000);
                        })
                        .catch(error => {
                            const translatedMessage = firebaseErrorMessages[error.code] || error.message;
                            authMessage.innerHTML = "–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ª–∏—Å—Ç–∞: " + translatedMessage;
                        });
                })
                .catch(error => {
                    const translatedMessage = firebaseErrorMessages[error.code] || error.message;
                    authMessage.innerHTML = "–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: " + translatedMessage;
                });
        });

        function resendVerificationEmail() {
            const user = auth.currentUser;
            if (user) {
                sendEmailVerification(user)
                    .then(() => {
                        let seconds = 60;
                        authMessage.innerHTML = `–õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–Ω–æ–≤—É! –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç —â–µ —Ä–∞–∑ –º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ ${seconds} —Å.`;
                        const timer = setInterval(() => {
                            seconds--;
                            if (seconds > 0) {
                                authMessage.innerHTML = `–õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–Ω–æ–≤—É! –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç —â–µ —Ä–∞–∑ –º–æ–∂–Ω–∞ —á–µ—Ä–µ–∑ ${seconds} —Å.`;
                            } else {
                                clearInterval(timer);
                                authMessage.innerHTML = "–õ–∏—Å—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–Ω–æ–≤—É! <button id='resendEmailBtn' class='resend-btn'>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —â–µ —Ä–∞–∑</button>";
                                document.getElementById('resendEmailBtn').addEventListener('click', resendVerificationEmail);
                            }
                        }, 1000);
                    })
                    .catch(error => {
                        const translatedMessage = firebaseErrorMessages[error.code] || error.message;
                        authMessage.innerHTML = "–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è: " + translatedMessage;
                    });
            }
        }
        
        forgotPasswordBtn.addEventListener('click', () => {
            const email = emailInput.value;
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        authMessage.textContent = "–õ–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ –≤–∞—à—É –ø–æ—à—Ç—É.";
                    })
                    .catch(error => {
                        const translatedMessage = firebaseErrorMessages[error.code] || error.message;
                        authMessage.textContent = "–ü–æ–º–∏–ª–∫–∞: " + translatedMessage;
                    });
            } else {
                authMessage.textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å email –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è.";
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                if (user.emailVerified) {
                    authMessage.innerHTML = "";
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    document.body.classList.remove('auth-locked');
                    dbRef = ref(db, 'users/' + user.uid + '/refundTable');
                    userSettingsRef = ref(db, 'users/' + user.uid + '/settings');
                    columnWidthsRef = ref(db, 'users/' + user.uid + '/columnWidths');
                    fetchExchangeRate();

                    // Load settings and column widths from Firebase
                    onValue(userSettingsRef, snapshot => {
                        const settings = snapshot.val() || {};
                        applyTheme(settings.theme || 'dark');
                        themeSelector.value = settings.theme || 'dark';
                        monthFormatSelector.value = settings.monthFormat || 'words';
                        
                        onValue(columnWidthsRef, snapshot => {
                            loadColumnWidths(snapshot.val());
                        }, { onlyOnce: true });
                    });
                    
                    // Check if this is the first login
                    get(dbRef).then((snapshot) => {
                        const data = snapshot.val();
                        if (data && data.length > 0) {
                            restoreData();
                        } else {
                            // First login, create one empty row
                            set(dbRef, [{}]).then(() => {
                                restoreData();
                            });
                        }
                    }).catch((error) => {
                        console.error("Error checking for user data:", error);
                    });
                } else {
                    authMessage.innerHTML = "–í–∞—à email –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è. <button id='resendEmailBtn' class='resend-btn'>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —â–µ —Ä–∞–∑</button>";
                    document.getElementById('resendEmailBtn').addEventListener('click', resendVerificationEmail);
                    authContainer.style.display = 'flex';
                    appContainer.style.display = 'none';
                    document.body.classList.add('auth-locked');
                    tableBody.innerHTML = '';
                    updateMonthFilter([]);
                    updateStats();
                }
            } else {
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                document.body.classList.add('auth-locked');
                tableBody.innerHTML = '';
                updateMonthFilter([]);
                updateStats();
            }
        });

        function convertToUAH() {
            const usd = parseFloat(usdInput.value);
            if (!isNaN(usd)) {
                uahInput.value = (usd * exchangeRate).toFixed(2);
            }
        }

        function convertToUSD() {
            const uah = parseFloat(uahInput.value);
            if (!isNaN(uah)) {
                usdInput.value = (uah / exchangeRate).toFixed(2);
            }
        }

        uahInput.addEventListener('input', convertToUSD);
        usdInput.addEventListener('input', convertToUAH);

        function updateMonthFilter(data = []) {
            const format = monthFormatSelector.value || 'words';
            monthFilter.innerHTML = '<option value="all">–í—Å—ñ</option>';
            const uniqueMonths = Array.from(new Set(data.map(d => d.month))).filter(v => v).sort((a, b) => a - b);
            
            uniqueMonths.forEach(monthNumber => {
                const option = document.createElement('option');
                option.value = monthNumber;
                option.textContent = getMonthString(monthNumber, format);
                monthFilter.appendChild(option);
            });
            applyFilter();
        }
        
        // This function calculates profit and updates costs based on the new logic
        function calculateProfit(tr) {
            const priceOrderVal = tr.querySelector('.priceOrder').value;
            const priceProduct = parseFloat(tr.querySelector('.priceProduct').value) || 0;
            const priceWarmup = parseFloat(tr.querySelector('.priceWarmup').value) || 0;
            const priceSell = parseFloat(tr.querySelector('.priceSell').value) || 0;
            const productRefunded = tr.querySelector('.productRefunded').checked;
            const warmupRefunded = tr.querySelector('.warmupRefunded').checked;
            
            let costs = 0;
            if (priceOrderVal !== '') {
                costs = parseFloat(priceOrderVal) || 0;
            } else {
                costs = priceProduct + priceWarmup;
            }

            if (productRefunded && warmupRefunded) {
                costs = 0;
            } else if (productRefunded) {
                costs -= priceProduct;
            } else if (warmupRefunded) {
                costs -= priceWarmup;
            }

            let profit = priceSell - costs;

            tr.querySelector('.profit').textContent = profit.toFixed(2);
            tr.querySelector('.totalCostsCell').textContent = costs.toFixed(2);
            tr.querySelector('.totalSalesCell').textContent = priceSell.toFixed(2);
        }

        function updateStats() {
            let totalProfit = 0;
            let totalCosts = 0;
            let totalSales = 0;
            
            document.querySelectorAll('#refundTable tbody tr').forEach(tr => {
                if (tr.style.display !== 'none') {
                    const priceOrderVal = tr.querySelector('.priceOrder').value;
                    const priceProduct = parseFloat(tr.querySelector('.priceProduct').value) || 0;
                    const priceWarmup = parseFloat(tr.querySelector('.priceWarmup').value) || 0;
                    const priceSell = parseFloat(tr.querySelector('.priceSell').value) || 0;
                    const productRefunded = tr.querySelector('.productRefunded').checked;
                    const warmupRefunded = tr.querySelector('.warmupRefunded').checked;
                    
                    let rowCost = 0;
                    if (priceOrderVal !== '') {
                        rowCost = parseFloat(priceOrderVal) || 0;
                    } else {
                        rowCost = priceProduct + priceWarmup;
                    }

                    if (productRefunded) {
                        rowCost -= priceProduct;
                    }
                    if (warmupRefunded) {
                        rowCost -= priceWarmup;
                    }
                    
                    const rowProfit = priceSell - rowCost;

                    totalProfit += rowProfit;
                    totalCosts += rowCost;
                    totalSales += priceSell;
                }
            });

            totalProfitSpan.textContent = totalProfit.toFixed(2);
            totalCostsSpan.textContent = totalCosts.toFixed(2);
            totalSalesSpan.textContent = totalSales.toFixed(2);
        }

        async function uploadImageToImgbb(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', IMGBB_API_KEY);

            try {
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    console.error('ImgBB upload error:', data.error.message);
                    return null;
                }
            } catch (error) {
                console.error('Network error uploading to ImgBB:', error);
                return null;
            }
        }

        function saveData() {
            const rows = [];
            document.querySelectorAll('#refundTable tbody tr').forEach(tr => {
                const row = {
                    month: tr.querySelector('.month').value,
                    profile: tr.querySelector('.profile').value,
                    email: tr.querySelector('.email').value,
                    pass: tr.querySelector('.pass').value,
                    phone: tr.querySelector('.phone').value,
                    productName: tr.querySelector('.productName').value,
                    priceProduct: tr.querySelector('.priceProduct').value,
                    priceWarmup: tr.querySelector('.priceWarmup').value,
                    priceOrder: tr.querySelector('.priceOrder').value,
                    priceSell: tr.querySelector('.priceSell').value,
                    productRefunded: tr.querySelector('.productRefunded').checked,
                    warmupRefunded: tr.querySelector('.warmupRefunded').checked,
                    imageData: tr.querySelector('.imgInput').dataset.image || ''
                };
                rows.push(row);
            });
            if(dbRef) {
                set(dbRef, rows);
            }
        }

        function restoreData() {
            if(dbRef) {
                onValue(dbRef, snapshot => {
                    const data = snapshot.val();
                    const currentFilter = monthFilter.value;
                    if (data) {
                        tableBody.innerHTML = '';
                        data.forEach(rowData => {
                            addRow(rowData);
                        });
                        updateMonthOptions(data);
                        updateMonthFilter(data);
                    } else {
                        tableBody.innerHTML = '';
                        updateMonthFilter([]);
                    }
                    if (currentFilter) {
                        monthFilter.value = currentFilter;
                    }
                    applyFilter();
                });
            }
        }
        
        // This function will handle the visibility of image-related elements
        function updateImageSection(tr, imageUrl) {
            const customUploadLabel = tr.querySelector('.custom-file-upload');
            const imgInput = tr.querySelector('.imgInput');
            const imagePreview = tr.querySelector('.preview');
            const deleteImgBtn = tr.querySelector('.delete-img-btn');

            if (imageUrl) {
                customUploadLabel.style.display = 'none';
                imagePreview.src = imageUrl;
                imagePreview.style.display = 'block';
                deleteImgBtn.style.display = 'inline-block';
                imgInput.dataset.image = imageUrl;
            } else {
                customUploadLabel.style.display = 'inline-block';
                imagePreview.src = '';
                imagePreview.style.display = 'none';
                deleteImgBtn.style.display = 'none';
                imgInput.dataset.image = '';
            }
        }

        // Helper function to update the visibility of the calculate button
        function updateCalculateButtonVisibility(tr) {
            const priceProduct = parseFloat(tr.querySelector('.priceProduct').value) || 0;
            const priceWarmup = parseFloat(tr.querySelector('.priceWarmup').value) || 0;
            const priceOrder = parseFloat(tr.querySelector('.priceOrder').value) || 0;
            const calculateBtn = tr.querySelector('.calculate-btn');
            
            const sumOfPrices = priceProduct + priceWarmup;
            
            if ((priceProduct > 0 || priceWarmup > 0) && Math.abs(sumOfPrices - priceOrder) > 0.01) {
                calculateBtn.style.display = 'block';
            } else {
                calculateBtn.style.display = 'none';
            }
        }

        function addRow(rowData = {}) {
            const tr = document.createElement('tr');
            const monthNumber = rowData.month || (new Date().getMonth() + 1);
            
            tr.innerHTML = `
                <td class="month-col">
                    <select class="month" data-month="${monthNumber}">
                        <option value="">-- –í–∏–±—Ä–∞—Ç–∏ –º—ñ—Å—è—Ü—å --</option>
                    </select>
                </td>
                <td><input class="profile" type="text" value="${rowData.profile || ''}"></td>
                <td><input class="email" type="text" value="${rowData.email || ''}"></td>
                <td><input class="pass" type="text" value="${rowData.pass || ''}"></td>
                <td><input class="phone" type="text" value="${rowData.phone || ''}"></td>
                <td><input class="productName" type="text" value="${rowData.productName || ''}"></td>
                <td><input class="priceProduct" type="text" value="${rowData.priceProduct || ''}"></td>
                <td><input class="priceWarmup" type="text" value="${rowData.priceWarmup || ''}"></td>
                <td class="order-price-cell">
                    <input class="priceOrder" type="text" value="${rowData.priceOrder || ''}">
                    <button class="calculate-btn">üßÆ</button>
                </td>
                <td><input class="priceSell" type="text" value="${rowData.priceSell || ''}"></td>
                <td><input type="checkbox" class="productRefunded" ${rowData.productRefunded ? 'checked' : ''}></td>
                <td><input type="checkbox" class="warmupRefunded" ${rowData.warmupRefunded ? 'checked' : ''}></td>
                <td class="image-col">
                    <div class="image-controls">
                        <label class="custom-file-upload">
                            <input type="file" class="imgInput" accept="image/*" style="display:none;">
                            –í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª
                        </label>
                        <img src="" class="preview" style="display:none;">
                        <button class="delete-img-btn" style="display:none;">üóëÔ∏è</button>
                    </div>
                </td>
                <td class="profit">${rowData.profit || '0.00'}</td>
                <td class="totalCostsCell" style="display: none;">${rowData.totalCosts || '0.00'}</td>
                <td class="totalSalesCell" style="display: none;">${rowData.totalSales || '0.00'}</td>
                <td><button class="remove-btn">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>
            `;
            
            const monthSelect = tr.querySelector('.month');
            const format = monthFormatSelector.value || 'words';
            monthSelect.innerHTML = `
                <option value="">-- –í–∏–±—Ä–∞—Ç–∏ –º—ñ—Å—è—Ü—å --</option>
                ${monthNames.map((m, i) => `<option value="${i + 1}" ${monthNumber == i + 1 ? 'selected' : ''}>${format === 'words' ? m : `${String(i + 1).padStart(2, '0')}.${new Date().getFullYear()}`}</option>`).join('')}
            `;
            
            updateImageSection(tr, rowData.imageData);
            updateCalculateButtonVisibility(tr);

            const inputs = tr.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    saveData();
                    if (input.classList.contains('month')) {
                        onValue(dbRef, snapshot => updateMonthFilter(snapshot.val()), { onlyOnce: true });
                    }
                });
            });

            const priceInputs = tr.querySelectorAll('.priceProduct, .priceWarmup, .priceOrder, .priceSell');
            priceInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const value = input.value.trim();
                    if (value.endsWith('$')) {
                        const usdAmount = parseFloat(value.slice(0, -1));
                        if (!isNaN(usdAmount)) {
                            input.value = (usdAmount * exchangeRate).toFixed(2);
                        }
                    }
                    
                    if (input.classList.contains('priceProduct') || input.classList.contains('priceWarmup') || input.classList.contains('priceOrder')) {
                        updateCalculateButtonVisibility(tr);
                    }

                    calculateProfit(tr);
                    updateStats();
                });
                input.addEventListener('change', saveData);
            });
            
            const calculateBtn = tr.querySelector('.calculate-btn');
            calculateBtn.addEventListener('mousedown', () => { 
                const priceProduct = parseFloat(tr.querySelector('.priceProduct').value) || 0;
                const priceWarmup = parseFloat(tr.querySelector('.priceWarmup').value) || 0;
                const priceOrderInput = tr.querySelector('.priceOrder');
                if (!isNaN(priceProduct) || !isNaN(priceWarmup)) {
                    priceOrderInput.value = (priceProduct + priceWarmup).toFixed(2);
                    calculateProfit(tr);
                    saveData();
                    updateCalculateButtonVisibility(tr);
                }
            });


            tr.querySelector('.productRefunded').addEventListener('change', () => { calculateProfit(tr); saveData(); updateStats(); });
            tr.querySelector('.warmupRefunded').addEventListener('change', () => { calculateProfit(tr); saveData(); updateStats(); });
            tr.querySelector('.remove-btn').addEventListener('click', () => removeRow(tr));
            
            const imgInput = tr.querySelector('.imgInput');
            const deleteImgBtn = tr.querySelector('.delete-img-btn');
            const imagePreview = tr.querySelector('.preview');

            deleteImgBtn.addEventListener('click', () => {
                updateImageSection(tr, '');
                saveData();
            });

            imgInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const imageUrl = await uploadImageToImgbb(file);
                    if (imageUrl) {
                        updateImageSection(tr, imageUrl);
                        saveData();
                    }
                }
            });

            imagePreview.addEventListener('click', function() {
                openModal(this.src);
            });

            tableBody.appendChild(tr);
            calculateProfit(tr);
        }

        function removeRow(tr) {
            const rowIndex = Array.from(tableBody.children).indexOf(tr);
            
            if (dbRef) {
                onValue(dbRef, snapshot => {
                    const data = snapshot.val() || [];
                    data.splice(rowIndex, 1);
                    set(dbRef, data).then(() => {
                        tr.remove();
                        updateStats();
                        onValue(dbRef, snapshot => updateMonthFilter(snapshot.val()), { onlyOnce: true });
                    });
                }, {
                    onlyOnce: true
                });
            }
        }

        function filterRow(tr) {
            const selected = monthFilter.value;
            const m = tr.querySelector('.month').value;
            return selected === 'all' || m === selected;
        }

        function applyFilter() {
            document.querySelectorAll('#refundTable tbody tr').forEach(tr => {
                tr.style.display = filterRow(tr) ? '' : 'none';
            });
            updateStats();
        }

        addRowBtn.addEventListener('click', () => { addRow(); saveData(); });
        clearDataBtn.addEventListener('click', () => {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ?")) {
                tableBody.innerHTML = '';
                if(dbRef) {
                    set(dbRef, null);
                }
                updateStats();
                updateMonthFilter([]);
            }
        });

        monthFilter.addEventListener('change', applyFilter);

        function openModal(src) {
            const modal = document.getElementById('imgModal');
            modal.querySelector('img').src = src;
            modal.classList.add('open');
        }
        document.querySelector('#imgModal .close').addEventListener('click', () => {
            document.getElementById('imgModal').classList.remove('open');
        });
        document.getElementById('imgModal').addEventListener('click', e => {
            if (e.target.id === 'imgModal') { e.currentTarget.classList.remove('open'); }
        });

        // Column resizing logic
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                const th = e.target.parentElement;
                const table = document.getElementById('refundTable');
                let startX = e.pageX;
                let startWidth = th.offsetWidth;
                
                function doDrag(e) {
                    const newWidth = startWidth + (e.pageX - startX);
                    th.style.width = `${newWidth}px`;
                    table.style.tableLayout = 'fixed';
                    saveColumnWidths(); 
                }

                function stopDrag() {
                    document.documentElement.removeEventListener('mousemove', doDrag, false);
                    document.documentElement.removeEventListener('mouseup', stopDrag, false);
                }

                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
            });
        });
    </script>
</body>
</html>